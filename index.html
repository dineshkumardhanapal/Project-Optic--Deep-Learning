<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intelli-Invoice Extractor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --matte-blue: #2c3e50;
            --royal-white: #ecf0f1;
            --accent-blue: #3498db;
            --light-gray: #bdc3c7;
            --highlight-yellow: rgba(255, 255, 0, 0.4);
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--royal-white);
        }
        .bg-matte-blue { background-color: var(--matte-blue); }
        .text-royal-white { color: var(--royal-white); }
        .accent-bg { background-color: var(--accent-blue); }
        .accent-text { color: var(--accent-blue); }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--accent-blue);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #pdf-viewer-container {
            position: relative;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            height: calc(100vh - 200px);
            overflow: auto;
        }
        #pdf-canvas {
            display: block;
        }
        .highlight-box {
            position: absolute;
            background-color: var(--highlight-yellow);
            border: 2px solid yellow;
            border-radius: 3px;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-royal-white">

    <header class="bg-matte-blue shadow-md">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-royal-white">Intelli-Invoice Extractor</h1>
            <button id="export-excel-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                Export to Excel
            </button>
        </div>
    </header>

    <main class="container mx-auto p-4 mt-4">
        <div id="upload-section" class="text-center bg-white p-8 rounded-lg shadow-lg">
            <h2 class="text-2xl font-semibold text-matte-blue mb-4">Upload Your Invoices</h2>
            <div class="flex justify-center items-center space-x-4">
                <div class="file-input-wrapper">
                    <label for="single-upload" class="bg-accent-blue hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg cursor-pointer transition-colors shadow-md">Upload Single PDF</label>
                    <input id="single-upload" type="file" accept=".pdf" class="hidden">
                </div>
                <div class="file-input-wrapper">
                    <label for="bulk-upload" class="bg-accent-blue hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg cursor-pointer transition-colors shadow-md">Upload Bulk PDFs</label>
                    <input id="bulk-upload" type="file" accept=".pdf" multiple class="hidden">
                </div>
            </div>
            <p id="file-info" class="text-gray-500 mt-4"></p>
        </div>

        <div id="processing-section" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Left Side: PDF Viewer -->
                <div class="bg-white p-4 rounded-lg shadow-lg">
                    <h3 class="text-xl font-semibold text-matte-blue mb-2">Document Viewer</h3>
                    <div id="pdf-viewer-container">
                        <canvas id="pdf-canvas"></canvas>
                    </div>
                </div>

                <!-- Right Side: Extracted Data -->
                <div class="bg-white p-4 rounded-lg shadow-lg">
                    <h3 class="text-xl font-semibold text-matte-blue mb-2">Extracted Data</h3>
                    <div id="extracted-data-container" class="space-y-3 overflow-y-auto" style="height: calc(100vh - 200px);">
                        <!-- Data will be dynamically inserted here -->
                    </div>
                </div>
            </div>
        </div>

        <div id="loader-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex flex-col items-center justify-center z-50">
            <div class="loader"></div>
            <p id="loader-text" class="text-royal-white text-xl mt-4">Processing...</p>
        </div>
    </main>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;

        const singleUploadInput = document.getElementById('single-upload');
        const bulkUploadInput = document.getElementById('bulk-upload');
        const uploadSection = document.getElementById('upload-section');
        const processingSection = document.getElementById('processing-section');
        const loaderOverlay = document.getElementById('loader-overlay');
        const loaderText = document.getElementById('loader-text');
        const dataContainer = document.getElementById('extracted-data-container');
        const exportBtn = document.getElementById('export-excel-btn');
        const pdfViewerContainer = document.getElementById('pdf-viewer-container');
        const pdfCanvas = document.getElementById('pdf-canvas');

        let allExtractedData = [];
        let pdfScale = 1.0;

        singleUploadInput.addEventListener('change', (e) => handleFiles(e.target.files));
        bulkUploadInput.addEventListener('change', (e) => handleFiles(e.target.files));

        async function handleFiles(files) {
            if (files.length === 0) return;
            allExtractedData = [];
            dataContainer.innerHTML = '';
            exportBtn.disabled = true;

            uploadSection.classList.add('hidden');
            processingSection.classList.remove('hidden');
            loaderOverlay.classList.remove('hidden');

            await renderPdf(files[0]);

            // This function calls the live backend server.
            await processFilesWithBackend(files);
        }

        async function renderPdf(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            const page = await pdf.getPage(1);

            await new Promise(resolve => requestAnimationFrame(resolve));

            const containerWidth = pdfViewerContainer.clientWidth;
            const viewport = page.getViewport({ scale: 1.0 });
            pdfScale = containerWidth / viewport.width;
            const scaledViewport = page.getViewport({ scale: pdfScale });

            const context = pdfCanvas.getContext('2d');
            pdfCanvas.height = scaledViewport.height;
            pdfCanvas.width = scaledViewport.width;

            await page.render({ canvasContext: context, viewport: scaledViewport }).promise;
        }

        async function processFilesWithBackend(files) {
            const formData = new FormData();
            for (const file of files) {
                formData.append('invoices', file);
            }

            // ===================================================================
            // IMPORTANT: Replace this URL with your live Azure backend URL
            // ===================================================================
            const backendUrl = 'https://YOUR-AZURE-BACKEND-APP-NAME.azurewebsites.net/extract';

            if (backendUrl.includes('YOUR-AZURE-BACKEND-APP-NAME')) {
                alert('Configuration needed: Please update the backendUrl in the HTML file with your live server address.');
                loaderOverlay.classList.add('hidden');
                return;
            }

            loaderText.textContent = `Uploading and processing ${files.length} file(s)...`;

            try {
                const response = await fetch(backendUrl, {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    throw new Error(`Server responded with ${response.status}: ${response.statusText}`);
                }

                const apiResponses = await response.json();
                processApiResponse(apiResponses);

            } catch (error) {
                console.error('Error processing files:', error);
                alert(`An error occurred while communicating with the backend.\n\nError: ${error.message}\n\nPlease check the following:\n1. The backend URL is correct.\n2. The backend server is running.\n3. There are no network connectivity issues (like CORS).`);
                loaderOverlay.classList.add('hidden');
            }
        }

        function processApiResponse(responses) {
            allExtractedData = responses.map(res => ({ ...res.data, Filename: res.filename }));
            renderExtractedData(allExtractedData);
            loaderOverlay.classList.add('hidden');
            exportBtn.disabled = false;
        }

        function renderExtractedData(data) {
            dataContainer.innerHTML = '';
            data.forEach((item, index) => {
                const itemContainer = document.createElement('div');
                itemContainer.className = 'mb-4 border border-gray-300 rounded-lg shadow-sm';

                let formHtml = `<div class="p-2 bg-matte-blue text-royal-white rounded-t-lg"><h4 class="font-bold">File: ${item.Filename}</h4></div>`;
                formHtml += '<div class="p-4 bg-white rounded-b-lg space-y-4">';

                for (const [key, valueObj] of Object.entries(item)) {
                    if (key === 'Filename') continue;
                    const { answer, box } = valueObj;
                    const fieldId = `field-${index}-${key.replace(/\s+/g, '-')}`;

                    formHtml += `
                        <div>
                            <div class="flex items-center mb-1">
                                <label for="${fieldId}" class="block text-sm font-medium text-gray-700">${key}</label>
                                <button class="scan-btn ml-2 p-1 text-gray-400 hover:text-accent-blue" title="Find in document"
                                        data-box='${JSON.stringify(box)}'>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                            <input type="text" id="${fieldId}" value="${answer}" class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm p-2">
                        </div>
                    `;
                }
                formHtml += '</div>'; // close p-4 div
                itemContainer.innerHTML = formHtml;
                dataContainer.appendChild(itemContainer);
            });

            document.querySelectorAll('.scan-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const box = JSON.parse(e.currentTarget.dataset.box);
                    highlightOnPdf(box);
                });
            });
        }

        function highlightOnPdf(box) {
            const existingHighlights = pdfViewerContainer.querySelectorAll('.highlight-box');
            existingHighlights.forEach(h => h.remove());

            if (!box || box.length !== 4) return;

            const [x0, y0, x1, y1] = box;

            const highlight = document.createElement('div');
            highlight.className = 'highlight-box';
            highlight.style.left = `${x0 * pdfScale}px`;
            highlight.style.top = `${y0 * pdfScale}px`;
            highlight.style.width = `${(x1 - x0) * pdfScale}px`;
            highlight.style.height = `${(y1 - y0) * pdfScale}px`;

            pdfViewerContainer.appendChild(highlight);
            pdfViewerContainer.scrollTop = (y0 * pdfScale) - 50;
        }

        exportBtn.addEventListener('click', () => {
            const dataToExport = [];
            allExtractedData.forEach((item, index) => {
                const selectedData = { Filename: item.Filename };
                for (const [key, valueObj] of Object.entries(item)) {
                    if (key === 'Filename') continue;
                    const fieldId = `field-${index}-${key.replace(/\s+/g, '-')}`;
                    const input = document.getElementById(fieldId);
                    if (input) {
                        selectedData[key] = input.value;
                    }
                }
                dataToExport.push(selectedData);
            });

            if (dataToExport.length === 0) {
                alert("No data to export.");
                return;
            }

            const ws = XLSX.utils.json_to_sheet(dataToExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Invoices");
            XLSX.writeFile(wb, "extracted_invoices.xlsx");
        });

    </script>
</body>
</html>
